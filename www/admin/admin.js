// Generated by CoffeeScript 1.8.0
var d;

$(function() {
  $.fn.flashMessage = function(obj, msg) {
    if (msg != null) {
      obj.text(msg);
    }
    obj.fadeIn();
    setTimeout(function() {
      obj.fadeOut();
      location.hash = Math.floor(Math.random() * 10001);
    }, 1500);
    return this;
  };
  $('a.delete').click(function() {
    var form, msg, url;
    url = this.href;
    form = $(this).parents('form');
    msg = '';
    if (($(this).attr('my_label') != null) && $(this).attr('my_label') !== '') {
      msg = '[ ' + $(this).attr('my_label') + ' ]を';
    }
    msg += '削除します。よろしいですか？<br>削除すると元には戻せません。';
    bootbox.confirm(msg, function(result) {
      if (result) {
        form.submit();
      }
    });
    return false;
  });
  $('.datepicker').datetimepicker({
    language: 'ja',
    format: 'YYYY-MM-DD',
    pickTime: false
  });
  $('.datetimepicker').datetimepicker({
    language: 'ja',
    format: 'YYYY-MM-DD HH:mm:00'
  });
  $('.sortable-table').sortable({
    items: 'tbody tr',
    handle: '.handle',
    placeholder: 'info',
    cursor: 'move',
    axis: 'y',
    opacity: 0.5,
    helper: function(e, tr) {
      var $helper, $originals;
      $originals = tr.children();
      $helper = tr.clone();
      $helper.children().each(function(index) {
        $(this).width($originals.eq(index).width());
      });
      return $helper;
    },
    create: function(event, ui) {
      var result;
      result = $(this).sortable('toArray').map(function(v) {
        return v.replace('item_', '');
      });
      $('#sort_nums').val(result);
    },
    update: function(event, ui) {
      var result;
      result = $(this).sortable('toArray').map(function(v) {
        return v.replace('item_', '');
      });
      $('#sort_nums').val(result);
    }
  });
  $('input[type=file]').change(function() {
    var file, preview, reader;
    preview = $(this).prev('div .preview');
    file = this.files[0];
    if (file) {
      if (file.type.indexOf('image/') === 0) {
        reader = new FileReader();
        reader.onloadend = function() {
          preview.html($('<img>').attr({
            'src': reader.result,
            'width': 200
          }));
        };
        reader.readAsDataURL(file);
      } else {
        preview.html(file.name);
      }
    } else {
      preview.html('');
    }
  });

  $('a.approval_setting').click(function() {
    id       = $(this).attr('question_id');
    var target   = $(this);
    bootbox.prompt({
        title: "承認を行います。結果を以下の内容からお選び下さい。",
        inputType: 'select',
        inputOptions: [
            {
                text: '承認OK',
                value: 'ok',
            },
            {
                text: '承認NG',
                value: 'ng',
            }
        ],
        callback: function (result) {
            if(result === null){
                return true;
            }
            $.ajax({
                url: "/admin/question/approval_preference/",
                type: "post",
                dataType: "json",
                data: {
                    csrf_token: $('[name=csrf_token]').val(),
                    question_id: id,
                    result: result
                }
            }).done(function (response) {
                if(result == 'ok'){
                    target.replaceWith('<i class="fa fa-check-circle"></i>');
                }else{
                    target.replaceWith('<i class="fa fa-remove"></i>');
                }
            }).fail(function(jqXHR) {
                document.head.innerHTML = "";
                document.body.innerHTML = jqXHR.responseText;
            });

        }
    });
    $('.bootbox .modal-body .bootbox-body').before('<p>部位症状:'+$(this).parents('tr').find('.question_category').html()+'</p>');
    $('.bootbox .modal-body .bootbox-body').before('<p>内容:'+$(this).parents('tr').find('.question_content').html()+'</p>');
  });
  
  $('a.show_setting').click(function() {
    id       = $(this).attr('question_id');
    show_flg = $(this).attr('show_flg');
    var target   = $(this);
    bootbox.prompt({
        title: "公開設定を行います。結果を以下の内容からお選び下さい。",
        inputType: 'select',
        inputOptions: [
            {
                text: '公開',
                value: '1',
            },
            {
                text: '非公開',
                value: '0',
            }
        ],
        callback: function (result) {
            if(result === null){
                return true;
            }
            if(target.attr('show_flg') == result){
                return true; 
            }

            $.ajax({
                url: "/admin/question/show_preference/",
                type: "post",
                dataType: "json",
                data: {
                    csrf_token: $('[name=csrf_token]').val(),
                    question_id: id,
                    result: result
                }
            }).done(function (response) {
                if(result == 1){
                    target.removeClass('btn-danger');
                    target.addClass('btn-primary');
                    target.html('<i class="fa fa-wifi"></i> 公開');
                    target.attr('show_flg',1);
                }
                else {
                    target.removeClass('btn-primary');
                    target.addClass('btn-danger');
                    target.html('<i class="fa fa-warning"></i> 非公開');
                    target.attr('show_flg',0);
                }
            }).fail(function(jqXHR) {
                document.head.innerHTML = "";
                document.body.innerHTML = jqXHR.responseText;
            });
        }
    });
    $('.bootbox .modal-body .bootbox-body').before('<p>部位症状:'+$(this).parents('tr').find('.question_category').html()+'</p>');
    $('.bootbox .modal-body .bootbox-body').before('<p>内容:'+$(this).parents('tr').find('.question_content').html()+'</p>');
    $('.bootbox .bootbox-input-select').val([show_flg]);
  });

});

d = function(v) {
  if ((typeof console !== "undefined" && console !== null) && (console.log != null)) {
    return console.log(v);
  }
};


